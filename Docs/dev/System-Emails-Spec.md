# System Emails Specification - Tier 1

**Product**: Explain My IT - Tier 1  
**Version**: 1.0  
**Created**: January 28, 2026  
**Status**: Ready to Implement

---

## Email Flow Overview

```
Request Snapshot
    ↓
[Email 1: Processing Confirmation] ← Optional (v1.1)
    ↓
Snapshot Generated (30-60s)
    ↓
[Email 2: Snapshot Complete + Magic Link] ← CRITICAL
    ↓
User views report
    ↓
User creates account
    ↓
[Email 3: Welcome + Account Created] ← CRITICAL
    ↓
T+46 hours (2h before expiry)
    ↓
[Email 4: Report Expiring Soon] ← Optional (v1.0)
    ↓
T+48 hours
    ↓
Report expires (magic link no longer works)
```

---

## Email 1: Snapshot Complete + Magic Link

**Priority**: P0 (Critical)  
**Trigger**: Snapshot generation complete  
**Timing**: Within 60 seconds of request  
**Brevo Template ID**: `snapshot-complete`

### Purpose

1. Deliver snapshot summary (value preview)
2. Provide magic link to full report
3. Set expectations (expiry, what's next)
4. Drive conversion (view dashboard)

### Email Content

**Subject**: `Your IT Snapshot for {domain} is ready`

**From**: `Explain My IT <reports@explainmyit.com>`

**Plain Text Body**:

```
Your IT Snapshot for {domain}

Hi,

Your IT snapshot is ready. Here's what we found:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

QUICK SUMMARY

{llm_email_summary}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

VIEW FULL REPORT

Click here to view your complete snapshot:
{magic_link_url}

This link is valid for 48 hours.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

WHAT'S IN THE FULL REPORT

• Plain-English explanations of what we found
• Specific risks and assumptions about your setup
• Questions you may want to ask your IT team or MSP
• Technical details for each area we checked

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

SAVE THIS REPORT

Create a free account to:
• Save this report permanently
• Run more snapshots (1 per domain every 30 days)
• Track changes over time

You can do this when you view your report.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Questions? Reply to this email.

Explain My IT
https://explainmyit.com
```

### Variables (Brevo)

```javascript
{
  "domain": "example.com",
  "llm_email_summary": "Generated by LLM Prompt 5",
  "magic_link_url": "https://explainmyit.com/snapshot/eyJhb...",
  "expiry_hours": "48"
}
```

### Umami Tracking

**UTM Parameters on magic link**:
```
?utm_source=email
&utm_medium=snapshot-complete
&utm_campaign=tier1-conversion
&utm_content=magic-link
```

**Events to track**:
- `email-snapshot-complete-sent` (server-side)
- `email-snapshot-complete-opened` (Brevo webhook)
- `email-magic-link-clicked` (via UTM parameters on page view)

### Brevo Configuration

**API Endpoint**: `POST /v3/smtp/email`

```json
{
  "to": [{"email": "user@example.com"}],
  "templateId": 1,
  "params": {
    "DOMAIN": "example.com",
    "SUMMARY": "Generated summary text...",
    "MAGIC_LINK": "https://explainmyit.com/snapshot/token?utm_source=email&utm_medium=snapshot-complete&utm_campaign=tier1-conversion&utm_content=magic-link",
    "EXPIRY_HOURS": "48"
  },
  "tags": ["snapshot-complete", "tier1"]
}
```

**Contact Attributes to Update**:
- `LAST_SNAPSHOT_DATE` = now()
- `TOTAL_SNAPSHOTS` = +1
- `LAST_SNAPSHOT_DOMAIN` = domain
- `SNAPSHOT_STATUS` = "completed"

### Success Criteria

- [x] Email delivers within 90 seconds of snapshot completion
- [x] Magic link works correctly
- [x] Summary preview is accurate and helpful
- [x] UTM tracking works
- [x] Mobile rendering is good

---

## Email 2: Welcome + Account Created

**Priority**: P0 (Critical)  
**Trigger**: User completes Supabase Auth signup  
**Timing**: Immediately after email verification  
**Brevo Template ID**: `account-welcome`

### Purpose

1. Confirm account creation
2. Explain what they can do now
3. Set expectations for future use
4. Drive engagement (run another snapshot)

### Email Content

**Subject**: `Welcome to Explain My IT`

**From**: `Explain My IT <hello@explainmyit.com>`

**Plain Text Body**:

```
Welcome to Explain My IT

Hi,

Your free account is ready.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

WHAT YOU CAN DO NOW

• View all your saved snapshots in one place
• Run new snapshots (1 per domain every 30 days)
• Access your reports anytime
• Track changes to your IT environment

View your dashboard:
https://explainmyit.com/dashboard?utm_source=email&utm_medium=welcome&utm_campaign=engagement

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

YOUR SAVED REPORTS

{report_count} snapshot(s) saved:
{domain_list}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

WHAT'S NEXT

This is a free service. You can:
• Keep using free snapshots (limited)
• Wait for paid tiers (recurring snapshots, internal checks, alerts)

We'll email when paid plans launch.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Need help? Reply to this email.

Explain My IT
https://explainmyit.com
```

### Variables (Brevo)

```javascript
{
  "user_email": "user@example.com",
  "report_count": "1",
  "domain_list": "• example.com (generated 5 minutes ago)",
  "dashboard_url": "https://explainmyit.com/dashboard?utm_source=email&utm_medium=welcome&utm_campaign=engagement"
}
```

### Umami Tracking

**UTM Parameters**:
```
?utm_source=email
&utm_medium=welcome
&utm_campaign=engagement
&utm_content=dashboard-link
```

**Events to track**:
- `email-welcome-sent` (server-side)
- `email-welcome-opened` (Brevo webhook)
- `email-dashboard-link-clicked` (via UTM on page view)
- `account-created` (already tracked in signup flow)

### Brevo Configuration

**API Endpoint**: `POST /v3/smtp/email`

```json
{
  "to": [{"email": "user@example.com"}],
  "templateId": 2,
  "params": {
    "USER_EMAIL": "user@example.com",
    "REPORT_COUNT": "1",
    "DOMAIN_LIST": "• example.com",
    "DASHBOARD_URL": "https://explainmyit.com/dashboard?utm_source=email&utm_medium=welcome&utm_campaign=engagement"
  },
  "tags": ["welcome", "onboarding"]
}
```

**Contact Attributes to Update**:
- `ACCOUNT_CREATED` = true
- `ACCOUNT_CREATED_DATE` = now()
- `LEAD_STATUS` = "activated"
- `USER_TIER` = "free"

### Success Criteria

- [x] Email delivers immediately after signup
- [x] Dashboard link works correctly
- [x] Report count is accurate
- [x] Sets correct expectations
- [x] Mobile rendering is good

---

## Email 3: Report Expiring Soon (Optional - v1.0)

**Priority**: P2 (Optional for launch)  
**Trigger**: T+46 hours after snapshot generation  
**Timing**: 2 hours before expiry  
**Brevo Template ID**: `report-expiring`

### Purpose

1. Create urgency to view report
2. Encourage account creation
3. Prevent user regret ("I should have saved that")

### Email Content

**Subject**: `Your IT snapshot for {domain} expires in 2 hours`

**From**: `Explain My IT <reports@explainmyit.com>`

**Plain Text Body**:

```
Your snapshot expires soon

Hi,

Your IT snapshot for {domain} expires in 2 hours.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

VIEW NOW

{magic_link_url}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

SAVE PERMANENTLY

Create a free account to:
• Keep this report forever
• Run more snapshots
• Track changes over time

You can do this from your report page.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

After 2 hours, this link will no longer work.

Explain My IT
https://explainmyit.com
```

### Variables (Brevo)

```javascript
{
  "domain": "example.com",
  "magic_link_url": "https://explainmyit.com/snapshot/token?utm_source=email&utm_medium=expiry-reminder&utm_campaign=retention",
  "hours_remaining": "2"
}
```

### Umami Tracking

**UTM Parameters**:
```
?utm_source=email
&utm_medium=expiry-reminder
&utm_campaign=retention
&utm_content=last-chance
```

**Events to track**:
- `email-expiring-sent` (server-side)
- `email-expiring-opened` (Brevo webhook)
- `email-expiring-link-clicked` (via UTM)
- `report-expired-without-account` (if not claimed)

### Brevo Configuration

**API Endpoint**: `POST /v3/smtp/email`

**Scheduled via**: Vercel cron job

```json
{
  "to": [{"email": "user@example.com"}],
  "templateId": 3,
  "params": {
    "DOMAIN": "example.com",
    "MAGIC_LINK": "https://explainmyit.com/snapshot/token?utm_source=email&utm_medium=expiry-reminder&utm_campaign=retention",
    "HOURS_REMAINING": "2"
  },
  "tags": ["expiry-reminder", "retention"]
}
```

**Only send if**:
- User has NOT created an account
- Magic link has NOT been clicked yet (or only once)
- Snapshot is still valid

### Success Criteria

- [x] Email sends exactly 2 hours before expiry
- [x] Only sends to users without accounts
- [x] Magic link still works
- [x] Increases conversion rate by >2%

---

## Email 4: Rate Limit Notification (Future)

**Priority**: P3 (Future - v1.1+)  
**Trigger**: User attempts snapshot within 30-day window  
**Purpose**: Explain rate limit, suggest upgrade

### Email Content

**Subject**: `You can run another snapshot for {domain} in {days} days`

**Plain Text Body**:

```
Snapshot limit reached

Hi,

You recently ran a snapshot for {domain} on {last_run_date}.

Free accounts can run 1 snapshot per domain every 30 days.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

NEXT AVAILABLE

You can run another snapshot for {domain} on {next_available_date}.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

NEED MORE?

Paid plans (coming soon) will include:
• Unlimited snapshots
• Recurring automatic checks
• Internal IT insights
• Change alerts

Join the waitlist:
https://explainmyit.com?utm_source=email&utm_medium=rate-limit&utm_campaign=upsell#waitlist

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Questions? Reply to this email.

Explain My IT
https://explainmyit.com
```

---

## Email 5: Account Verification (Supabase Default)

**Priority**: P0 (Critical)  
**Trigger**: User signs up with magic link  
**Source**: Supabase Auth (auto-generated)  
**Customization**: Yes (Supabase email templates)

### Purpose

1. Verify email address
2. Complete signup flow
3. Security check

### Customization Needed

**Template Override**: Yes (Supabase dashboard)

**Subject**: `Verify your email for Explain My IT`

**Body**: Use Supabase template editor to match brand tone.

**UTM Tracking**: Add to confirmation link
```
?utm_source=email
&utm_medium=verification
&utm_campaign=onboarding
```

---

## Brevo Setup Requirements

### 1. Email Templates

Create in Brevo dashboard:

| Template ID | Name | Status |
|-------------|------|--------|
| 1 | `snapshot-complete` | Required for launch |
| 2 | `account-welcome` | Required for launch |
| 3 | `report-expiring` | Optional (v1.0) |
| 4 | `rate-limit-notification` | Future (v1.1) |

### 2. Contact Attributes

Update existing Brevo contact schema:

```javascript
// Existing (already configured)
COMPANY_SIZE: text
HAS_IT: text
SIGNUP_SOURCE: text
SIGNUP_PAGE: text
LEAD_STATUS: text
UTM_SOURCE: text
UTM_MEDIUM: text
UTM_CAMPAIGN: text
REFERRER: text
LEAD_SCORE: number
SIGNUP_DATE: date

// NEW - Add for Tier 1
ACCOUNT_CREATED: boolean (default: false)
ACCOUNT_CREATED_DATE: date
USER_TIER: text (values: "free", "tier2", "tier3")
TOTAL_SNAPSHOTS: number (default: 0)
LAST_SNAPSHOT_DATE: date
LAST_SNAPSHOT_DOMAIN: text
SNAPSHOT_STATUS: text (values: "requested", "completed", "failed")
```

### 3. Automation Workflows

**Workflow 1: Snapshot Complete**
- Trigger: API call to Brevo
- Action: Send template 1
- Update attributes: TOTAL_SNAPSHOTS, LAST_SNAPSHOT_DATE, SNAPSHOT_STATUS

**Workflow 2: Account Welcome**
- Trigger: API call to Brevo (after Supabase signup)
- Action: Send template 2
- Update attributes: ACCOUNT_CREATED, ACCOUNT_CREATED_DATE, LEAD_STATUS, USER_TIER

**Workflow 3: Report Expiring (Optional)**
- Trigger: Vercel cron job (scheduled send)
- Condition: ACCOUNT_CREATED = false
- Action: Send template 3 at T+46h
- Track: If link clicked → update LEAD_STATUS

### 4. Webhooks

Configure in Brevo dashboard:

**Webhook URL**: `https://explainmyit.com/api/webhooks/brevo`

**Events to subscribe**:
- `email.opened`
- `email.clicked`
- `email.bounced`
- `email.spam`

**Payload handling**:
```typescript
// app/api/webhooks/brevo/route.ts
export async function POST(request: Request) {
  const payload = await request.json();
  
  switch(payload.event) {
    case 'email.opened':
      // Track in Umami: email-{template}-opened
      break;
    case 'email.clicked':
      // Track in Umami: email-{template}-clicked
      break;
    case 'email.bounced':
      // Update Supabase: mark email as invalid
      break;
  }
}
```

---

## Umami Analytics Integration

### Events to Track

**Server-Side** (via `lib/analytics.ts`):

```typescript
// After snapshot completion
trackEvent('email-snapshot-complete-sent', {
  domain: snapshot.domain,
  email_hash: hashEmail(userEmail),
  generation_time_seconds: duration
});

// After welcome email sent
trackEvent('email-welcome-sent', {
  email_hash: hashEmail(userEmail),
  reports_count: userReportCount
});

// After expiry reminder sent
trackEvent('email-expiring-sent', {
  domain: snapshot.domain,
  hours_before_expiry: 2
});
```

**Client-Side** (via UTM parameters → automatic Umami tracking):

```typescript
// When user lands on snapshot page from email
// Umami auto-tracks: utm_source, utm_medium, utm_campaign

// Additional custom events on snapshot page:
trackEvent('email-magic-link-clicked', {
  utm_medium: params.get('utm_medium'), // "snapshot-complete"
  has_account: !!user
});

// When user clicks upgrade banner (came from email)
trackEvent('upgrade-banner-clicked', {
  source: params.get('utm_source'), // "email"
  medium: params.get('utm_medium')
});
```

**Brevo Webhook → Umami** (via webhook handler):

```typescript
// app/api/webhooks/brevo/route.ts
import { trackEvent } from '@/lib/analytics';

export async function POST(request: Request) {
  const { event, email, tag } = await request.json();
  
  if (event === 'email.opened') {
    trackEvent(`email-${tag}-opened`, {
      email_hash: hashEmail(email)
    });
  }
  
  if (event === 'email.clicked') {
    trackEvent(`email-${tag}-clicked`, {
      email_hash: hashEmail(email),
      link: payload.link
    });
  }
}
```

### Conversion Funnel Tracking

Track the complete email → conversion flow:

```
1. email-snapshot-complete-sent
    ↓
2. email-snapshot-complete-opened (Brevo webhook)
    ↓
3. email-magic-link-clicked (UTM tracking)
    ↓
4. snapshot-dashboard-viewed (page view)
    ↓
5. upgrade-banner-viewed (client event)
    ↓
6. upgrade-banner-clicked (client event)
    ↓
7. signup-modal-opened (client event)
    ↓
8. signup-completed (Supabase callback)
    ↓
9. email-welcome-sent
    ↓
10. dashboard-first-view (UTM tracking)
```

### Dashboard Queries

Create in Umami dashboard:

**Email Performance**:
- Total emails sent (by type)
- Open rates (by type)
- Click rates (by type)
- Magic link → Dashboard conversion rate
- Dashboard → Signup conversion rate

**Conversion Attribution**:
- Signups from email (utm_source=email)
- Signups by email type (utm_medium)
- Time from email send to signup
- Reports saved per email type

---

## Implementation Checklist

### Phase 5.1: Email Templates (Day 22-23)

- [ ] Create `lib/email/templates.ts`
  - [ ] snapshotCompleteEmail()
  - [ ] accountWelcomeEmail()
  - [ ] reportExpiringEmail()
  - [ ] Include UTM parameters in all links
  
- [ ] Set up Brevo templates in dashboard
  - [ ] Template 1: Snapshot Complete
  - [ ] Template 2: Account Welcome
  - [ ] Template 3: Report Expiring (optional)
  
- [ ] Test email rendering
  - [ ] Gmail
  - [ ] Outlook
  - [ ] Apple Mail
  - [ ] Mobile clients

### Phase 5.2: Email Sender Logic (Day 23-24)

- [ ] Create `lib/email/sender.ts`
  - [ ] sendSnapshotComplete()
  - [ ] sendAccountWelcome()
  - [ ] sendReportExpiring()
  - [ ] Error handling & retry logic
  
- [ ] Update Brevo contact attributes
  - [ ] Add new attributes to schema
  - [ ] Update contacts on email send
  - [ ] Track email events

### Phase 5.3: Email Triggers (Day 24-25)

- [ ] Snapshot completion trigger
  - [ ] In `app/api/cron/generate-snapshot/route.ts`
  - [ ] After LLM generation complete
  - [ ] Include email summary in payload
  
- [ ] Account creation trigger
  - [ ] In `app/api/auth/callback/route.ts`
  - [ ] After Supabase signup complete
  - [ ] Fetch user's report count
  
- [ ] Expiry reminder trigger (optional)
  - [ ] Create cron job `app/api/cron/expiry-reminders/route.ts`
  - [ ] Run every hour
  - [ ] Query snapshots expiring in 2 hours
  - [ ] Only send if no account created

### Phase 5.4: Brevo Webhook (Day 25)

- [ ] Create `app/api/webhooks/brevo/route.ts`
  - [ ] Verify webhook signature
  - [ ] Handle email.opened event
  - [ ] Handle email.clicked event
  - [ ] Handle email.bounced event
  - [ ] Track events in Umami
  - [ ] Update Supabase if needed

### Phase 5.5: Umami Integration (Day 25-26)

- [ ] Add UTM parameters to all email links
  - [ ] Magic link URLs
  - [ ] Dashboard URLs
  - [ ] Upgrade CTA URLs
  
- [ ] Track server-side events
  - [ ] email-snapshot-complete-sent
  - [ ] email-welcome-sent
  - [ ] email-expiring-sent
  
- [ ] Track client-side events
  - [ ] email-magic-link-clicked
  - [ ] upgrade-banner-clicked (from email)
  
- [ ] Create Umami dashboard queries
  - [ ] Email performance metrics
  - [ ] Conversion attribution

### Phase 5.6: Testing (Day 26-27)

- [ ] End-to-end email flow test
  - [ ] Request snapshot → Receive email
  - [ ] Click magic link → View dashboard
  - [ ] Create account → Receive welcome
  - [ ] Wait 46h → Receive expiry (if no account)
  
- [ ] Email deliverability test
  - [ ] Check spam scores
  - [ ] Test in major email clients
  - [ ] Verify links work
  - [ ] Check mobile rendering
  
- [ ] Analytics tracking test
  - [ ] Verify all events fire
  - [ ] Check UTM parameters
  - [ ] Confirm webhook events
  - [ ] Validate conversion funnel

---

## Success Metrics

### Email Performance Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| Delivery rate | >98% | Brevo dashboard |
| Open rate (Snapshot Complete) | >50% | Brevo webhook |
| Click rate (Magic Link) | >60% | UTM + Umami |
| Open rate (Welcome) | >40% | Brevo webhook |
| Click rate (Dashboard) | >30% | UTM + Umami |
| Bounce rate | <2% | Brevo dashboard |
| Spam complaints | <0.1% | Brevo dashboard |

### Conversion Targets

| Funnel Step | Target Conversion | Measurement |
|-------------|-------------------|-------------|
| Email sent → Email opened | >50% | Brevo |
| Email opened → Link clicked | >70% | Brevo + Umami |
| Link clicked → Dashboard viewed | >95% | Umami |
| Dashboard viewed → Banner clicked | >10% | Umami |
| Banner clicked → Account created | >50% | Umami |
| **Total: Email → Account** | **>3%** | **Umami funnel** |

---

## File Structure

```
d:\Projects\ExplainMyIT\
├── lib/
│   └── email/
│       ├── templates.ts           # All email templates
│       ├── sender.ts              # Send logic + Brevo API
│       └── utils.ts               # UTM builder, email validation
├── app/
│   └── api/
│       ├── webhooks/
│       │   └── brevo/
│       │       └── route.ts       # Webhook handler
│       └── cron/
│           └── expiry-reminders/
│               └── route.ts       # Optional: Expiry emails
└── Docs/dev/
    └── System-Emails-Spec.md      # This file
```

---

## Environment Variables

Add to `.env.local`:

```bash
# Brevo (already configured)
BREVO_API_KEY=your_api_key

# Brevo Template IDs
BREVO_TEMPLATE_SNAPSHOT_COMPLETE=1
BREVO_TEMPLATE_ACCOUNT_WELCOME=2
BREVO_TEMPLATE_REPORT_EXPIRING=3

# Email Configuration
SYSTEM_EMAIL_FROM=reports@explainmyit.com
SYSTEM_EMAIL_FROM_NAME=Explain My IT
SYSTEM_EMAIL_REPLY_TO=hello@explainmyit.com

# Webhook Security
BREVO_WEBHOOK_SECRET=generate_secure_random_string
```

---

## Cost Estimates

### Email Volume (1,000 snapshots/month)

| Email Type | Volume | Cost (Brevo Free) | Notes |
|------------|--------|-------------------|-------|
| Snapshot Complete | 1,000 | $0 | Within free tier (300/day) |
| Account Welcome | 50 (5% conv) | $0 | Within free tier |
| Report Expiring | 950 (95% no account) | $0 | Within free tier |
| **Total** | **2,000/month** | **$0** | **Free tier: 9,000/month** |

Brevo free tier is sufficient for:
- Up to 4,500 snapshots/month
- Or 135,000 snapshots/month if we don't send expiry emails

---

## Next Steps

1. **Today**: Create email templates in `lib/email/templates.ts`
2. **Tomorrow**: Set up Brevo templates in dashboard
3. **Day 3**: Implement sender logic + triggers
4. **Day 4**: Set up webhook handler
5. **Day 5**: Integrate Umami tracking
6. **Day 6**: End-to-end testing

---

## Version History

### v1.0 (January 28, 2026)
- Initial email specification
- 5 system emails defined
- Brevo + Umami integration planned
- Complete implementation checklist

---

**This specification is ready to implement.**
